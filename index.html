<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BirdNet Log Decoder</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; color: #333; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
        
        /* Scanner Styles */
        #reader { width: 100%; border-radius: 8px; overflow: hidden; background: #000; }
        
        /* Status Box */
        .status-box { background: #e8f4fd; padding: 10px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #bce0fd; text-align: center; font-size: 14px; color: #0366d6; }
        
        /* Results Table */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; font-weight: 600; color: #555; }
        tr:hover { background-color: #f1f1f1; }
        
        .conf-high { color: #28a745; font-weight: bold; }
        .conf-med { color: #d39e00; }
        .conf-low { color: #dc3545; }
        
        .time-badge { background: #eee; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 0.9em; }
        
        #result-area { display: none; }

        /* Export Button Style */
        #exportBtn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 10px;
            display: inline-block;
        }
        #exportBtn:hover { background-color: #0056b3; }
    </style>
</head>
<body>

<div class="container">
    <h1>üê¶ Bird Log Decoder</h1>

    <div id="statusBox" class="status-box">Loading labels.txt...</div>

    <!-- Step 2: Scan -->
    <div id="reader"></div>

    <!-- Step 3: Results -->
    <div id="result-area">
        <h3>Session Data</h3>
        <button id="exportBtn">üì• Export to CSV</button>
        <table id="birdTable">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Species</th>
                    <th>Conf</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    let birdLabels = [];
    let currentDetections = []; // Store detections for export

    // --- 1. Automatically Fetch Labels File ---
    window.onload = function() {
        const statusBox = document.getElementById('statusBox');
        
        fetch('labels.txt')
            .then(response => {
                if (!response.ok) throw new Error("HTTP error " + response.status);
                return response.text();
            })
            .then(text => {
                // Split by newline and clean up
                birdLabels = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                
                statusBox.innerHTML = `‚úÖ <strong>Ready:</strong> ${birdLabels.length} species loaded from <em>labels.txt</em>`;
                statusBox.style.color = 'green';
                statusBox.style.borderColor = '#c3e6cb';
                statusBox.style.backgroundColor = '#d4edda';
            })
            .catch(error => {
                console.error('Fetch error:', error);
                statusBox.innerHTML = `‚ö†Ô∏è <strong>Note:</strong> Could not auto-load <em>labels.txt</em>.<br>Ensure the file is uploaded to GitHub in the same folder.`;
                statusBox.style.color = '#856404';
                statusBox.style.borderColor = '#ffeeba';
                statusBox.style.backgroundColor = '#fff3cd';
            });
    };

    // --- 2. Decoder Function ---
    function decodeBirdData(base64String) {
        try {
            // Decode Base64 to binary string
            const binaryString = atob(base64String);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            const detections = [];
            const packetSize = 5; // 2 bytes index + 2 bytes time + 1 byte conf

            // Loop through bytes in chunks of 5
            for (let i = 0; i < len; i += packetSize) {
                if (i + packetSize > len) break;

                // Bytes 0-1: Index (Big Endian)
                const index = (bytes[i] << 8) | bytes[i+1];
                
                // Bytes 2-3: Time Offset (Big Endian)
                const timeSec = (bytes[i+2] << 8) | bytes[i+3];
                
                // Byte 4: Confidence (0-255)
                const confRaw = bytes[i+4];
                
                // Formatting - Handle the "Index_Name" format from BirdNET
                let speciesName = `Unknown ID #${index}`;
                if (birdLabels[index]) {
                    // Split by underscore and take the last part (The Name)
                    // e.g. "Accipiter cooperii_Cooper's Hawk" -> "Cooper's Hawk"
                    speciesName = birdLabels[index].includes('_') ? birdLabels[index].split('_').pop() : birdLabels[index];
                }
                
                // Format Time (MM:SS)
                const minutes = Math.floor(timeSec / 60);
                const seconds = timeSec % 60;
                const timeStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Format Confidence
                const confPct = Math.round((confRaw / 255) * 100);

                detections.push({ time: timeStr, name: speciesName, conf: confPct });
            }
            
            return detections;

        } catch (err) {
            console.error("Decoding Error:", err);
            alert("Error decoding QR code. Is this a valid BirdNet Export?");
            return [];
        }
    }

    // --- 3. UI Rendering ---
    function renderResults(detections) {
        const tbody = document.querySelector('#birdTable tbody');
        tbody.innerHTML = ''; // Clear previous

        detections.forEach(bird => {
            const row = document.createElement('tr');
            
            let confClass = 'conf-low';
            if (bird.conf > 75) confClass = 'conf-high';
            else if (bird.conf > 50) confClass = 'conf-med';

            row.innerHTML = `
                <td><span class="time-badge">+${bird.time}</span></td>
                <td><strong>${bird.name}</strong></td>
                <td class="${confClass}">${bird.conf}%</td>
            `;
            tbody.appendChild(row);
        });

        document.getElementById('result-area').style.display = 'block';
    }

    // --- 4. CSV Export Function ---
    function downloadCSV() {
        if (!currentDetections || currentDetections.length === 0) {
            alert("No data to export!");
            return;
        }

        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Time Offset,Species,Confidence\n"; // Header

        currentDetections.forEach(function(bird) {
            csvContent += `${bird.time},${bird.name},${bird.conf}%\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "bird_session_log.csv");
        document.body.appendChild(link); // Required for FF
        link.click();
        document.body.removeChild(link);
    }

    document.getElementById('exportBtn').addEventListener('click', downloadCSV);

    // --- 5. Initialize Scanner ---
    function onScanSuccess(decodedText, decodedResult) {
        // Stop scanning after success
        html5QrcodeScanner.clear();
        
        currentDetections = decodeBirdData(decodedText); // Store for export
        renderResults(currentDetections);
    }

    function onScanFailure(error) {
        // handle scan failure, usually better to ignore and keep scanning.
    }

    let html5QrcodeScanner = new Html5QrcodeScanner(
        "reader",
        { fps: 10, qrbox: {width: 250, height: 250} },
        /* verbose= */ false);
    html5QrcodeScanner.render(onScanSuccess, onScanFailure);

</script>

</body>
</html>
